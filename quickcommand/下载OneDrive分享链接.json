{
    "features": {
        "code": "regex_v15sg5y0bz",
        "explain": "下载OneDrive分享链接",
        "cmds": [
            {
                "label": "下载OneDrive分享链接",
                "type": "regex",
                "match": "/https://.*.sharepoint.com/.*/",
                "minNum": 1
            }
        ],
        "icon": "data:image/png;base64,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",
        "platform": [
            "win32",
            "darwin",
            "linux"
        ]
    },
    "program": "quickcommand",
    "cmd": "utools.hideMainWindow();\n\nconst aria2path = 'https://localhost:6800/jsonrpc';\nconst aria2token = 'token';\nconst downloadpath = '/home/aria2';\n\n//let input = 'https://m95-my.sharepoint.com/:f:/g/personal/sijia_home_1ove_vip/EgtkStL13B5Agxiuanaz-AEBakm2lNvyyoiArrr3DguWUg?e=ozWy6M';\n\n(async () => {\n    if (quickcommand.enterData.type == 'regex') {\n        let input = quickcommand.enterData.payload\n        let result = await utools.ubrowser.goto(input)\n            .when('div.sign-in-box').show().end()\n            .when(() => (document.title == '登录未完成' || document.title == '共享链接验证' || document.title == '错误'))\n            .show()\n            .end()\n            .wait('div.ms-OverflowSet', 300000)\n            .when('div.ms-OverflowSet')\n            .hide()\n            .cookies()\n            .evaluate(() => {\n                (async () => {\n                    let fileList = [];\n                    let url = document.location;\n                    let host = url.host;\n                    let param = new URLSearchParams(url.search);\n                    let loc = param.get('id');\n                    let response = await fetch(`https://${host}${loc}`, {\n                        method: 'PROPFIND',\n                        credentials: 'include'\n                    });\n                    if (!response.ok) {\n                        // 失败\n                        if (response.status !== 404) {\n                            throw new Error(`无法解析OneDrive文件列表: ${response.status}`);\n                        }\n                        // 获取单文件信息\n                        let directLink = encodeURI(`https://${host}${loc}`);\n                        let parts = loc.split('/');\n                        let filename = parts[parts.length - 1];\n                        // 单个文件\n                        fileList.push({ filename, directLink });\n                    } else {\n                        // 成功：多个文件\n                        // 解析返回\n                        let xmlRaw = await response.text();\n                        let parser = new DOMParser();\n                        let xmlDoc = parser.parseFromString(xmlRaw, \"text/xml\");\n                        let fileEls = xmlDoc.getElementsByTagName('D:response');\n                        for (const el of fileEls) {\n                            let isFolderEl = el.getElementsByTagName('D:isFolder');\n                            // 当前不支持递归查找，所以跳过文件夹\n                            if (isFolderEl.length >= 1 && isFolderEl[0].textContent === 't') {\n                                continue;\n                            }\n                            // 获得文件 URL\n                            let hrefEl = el.getElementsByTagName('D:href');\n                            let directLink = \"\";\n                            if (hrefEl.length >= 1) {\n                                directLink = encodeURI(decodeURI(hrefEl[0].textContent));\n                            }\n                            // 获得文件名\n                            let nameEl = el.getElementsByTagName('D:displayname');\n                            let filename = \"\";\n                            if (nameEl.length >= 1) {\n                                filename = nameEl[0].textContent;\n                            }\n                            // 拼接结果\n                            fileList.push({ filename, directLink });\n                        }\n                    }\n                    document.body.innerHTML = \"<div class=json_file_list>\" + JSON.stringify(fileList) + \"<\\div>\";\n                })()\n            })\n            .wait('div.json_file_list', 10000)\n            .when('div.json_file_list').hide()\n            .evaluate(() => document.location.host)\n            .evaluate(() => document.body.innerText)\n            .end()\n            .end()\n            .run({ show: false });\n\n        let host = result[1];\n        const cookieKeys = [\n            { name: 'FedAuth', domain: host }, // 防止多站点之间 Cookie 混淆\n            { name: 'CCSInfo', domain: '.sharepoint.com' },\n            { name: 'rtFa', domain: '.sharepoint.com' }\n        ];\n        let cookies = result[0];\n        let cookie = 'Cookie: ';\n        cookies = cookieKeys.map(key => cookies.filter(item => (item.name == key.name && item.domain == key.domain))[0]);\n        cookies.forEach(item => {\n            cookie += `${item.name}=${item.value}; `;\n        });\n\n        let links = JSON.parse(result[2])\n            .map(item => {\n                let url = decodeURI(item.directLink);\n                let dir = downloadpath + url.replace(/https:\\/\\/.*\\/Documents(.*)\\/.*/g, '$1');\n                return { 'url': item.directLink, 'dir': dir };\n            });\n\n        let dataList = links.map(link => {\n            let data = {\n                jsonrpc: '2.0',\n                method: 'aria2.addUri',\n                id: 'script',\n                params: [\n                    'token:' + aria2token,\n                    [link.url],\n                    {\n                        dir: link.dir,\n                        header: [cookie],\n                        pause: 'true'\n                    }\n                ]\n            };\n            return data;\n        });\n\n        let succNum = 0;\n        let failNum = 0;\n        for (let i = 0; i < dataList.length; i++) {\n            let data = JSON.stringify(dataList[i]);\n            let response = await fetch(aria2path, {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json;charset=UTF-8' },\n                body: data\n            });\n            if (response.ok) {\n                succNum++;\n                console.log('添加任务成功：' + links[i].url);\n            } else {\n                failNum++;\n                console.error('添加任务失败：' + links[i].url)\n            }\n        }\n\n        utools.showMessageBox({\n            type: 'info',\n            title: '解析结果',\n            message: `成功：${succNum}\\n失败：${failNum}`\n        });\n    }\n})();",
    "output": "ignore",
    "hasSubInput": false,
    "scptarg": "",
    "charset": {
        "scriptCode": "",
        "outputCode": ""
    },
    "tags": [
        "私人"
    ]
}